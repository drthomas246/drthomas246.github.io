---
title: "git bashが遅い"
date: 2020-11-27T07:59:38+09:00
draft: false
math: false
---

Windows で git bash を使っているとイラっとするのが、git管理しているときにプロンプトの表示が異様に遅いことです。  
なぜなのか原因を追究してみると、どうも__git_ps1という関数が実行されて、プロンプトにブランチ名などを表示してくれるのですが、この処理が非常に遅いのです。  

### __git_ps1関数

この関数は/mingw64/share/git/completion/git-prompt.shの中に書かれています。なんと行数535行。(コメントを含む)  
gitコマンドだけでも20個程ある関数です。これだけあれば、遅くなるのも理解できます。  
実際どれくらいかかるのか確認してみました。

環境は、Intel Core i7-8550U CPU @ 1.80GHz 1.99GHz, RAM 16.0GB, Windows 10 Pro 64bitです。

ブランチ名以外に、  
「git管理add前」は、GIT_PS1_SHOWDIRTYSTATE(add前のファイルがあれば*、add後のファイルがあれば+を表示)と、GIT_PS1_SHOWUNTRACKEDFILES(add前の新規作成ファイルがあれば%を表示)のオプションを、  
「git管理commit後」には、上のオプションに追加して、GIT_PS1_SHOWUPSTREAM(HEADとアップストリームの差分)を表示させるようにしている。

| 回数 | git管理なし | git管理add前 | git管理commit後 |
|--:|--:|--:|--:|
| １回 | 0.109  | 0.518  | 0.770 |
| ２回 | 0.097  | 0.569  | 0.627 |
| ３回 | 0.098  | 0.580  | 0.756 |
| ４回 | 0.111  | 0.591  | 0.759 |
| ５回 | 0.086  | 0.504  | 0.764 |
| ６回 | 0.118  | 0.517  | 0.693 |
| ７回 | 0.110  | 0.560  | 0.817 |
| ８回 | 0.091  | 0.540  | 0.779 |
| ９回 | 0.112  | 0.641  | 0.871 |
| １０回 | 0.103  | 0.529  | 0.846 |
| 平均 | 0.104  | 0.555  | 0.768 |

１０回の平均を出した結果